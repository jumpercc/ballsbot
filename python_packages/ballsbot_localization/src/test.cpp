#include "grid.h"
#include "free_distances.h"
#include <iostream>

void TestBasics() {
    Pose pose = {0.1, 0.1, 0.1};
    PointCloud cloud = {{1., 2.}, {3., 4.}, {1.5, 0.}};
    Grid grid;

    grid.UpdateGrid(cloud, pose, 100500);

    for (auto tile_pair : grid.DebugGetTiles()) {
        auto tile_key = tile_pair.first;
        auto tile = tile_pair.second;
        auto voxels = tile.DebugGetVoxels();
        std::cout << "tile(" << tile_key.x << ", " << tile_key.y
                  << "): last_visited=" << tile.GetVisitedTs() << std::endl;
        for (int x = 0; x < voxels.size(); ++x) {
            for (int y = 0; y < voxels.size(); ++y) {
                auto voxel = voxels[x][y];
                if (voxel.occupied) {
                    std::cout << "voxel(" << x << ", " << y << "): occupied=" << voxel.occupied
                              << ", last_seen_occupied: " << voxel.last_seen_occupied_ts
                              << std::endl;
                }
            }
        }
    }

    std::cout << std::endl;
    PointCloud sparse = grid.GetSparsePointCloud(100501, 0., false);
    for (int i = 0; i < sparse.size(); ++i) {
        std::cout << sparse[i].x << ", " << sparse[i].y << std::endl;
    }

    std::cout << std::endl;
    sparse = grid.GetSparsePointCloud(100501, 4., false);
    for (int i = 0; i < sparse.size(); ++i) {
        std::cout << sparse[i].x << ", " << sparse[i].y << std::endl;
    }

    std::cout << std::endl;
    sparse = grid.GetSparsePointCloud(100501, 4., true);
    for (int i = 0; i < sparse.size(); ++i) {
        std::cout << sparse[i].x << ", " << sparse[i].y << std::endl;
    }

    std::cout << std::endl;
    sparse = grid.GetSparsePointCloud(100501, 0., true);
    for (int i = 0; i < sparse.size(); ++i) {
        std::cout << sparse[i].x << ", " << sparse[i].y << std::endl;
    }

    std::cout << std::endl;
    CarInfo car_info = {0.203, -0.02, 1.43 / 2, 0.157 + 0.153, 0.344 + 0.073};
    auto weights = grid.GetDirectionsWeights(100502, car_info);
    for (auto it : weights) {
        std::cout << "(" << it.first.steering << ", " << it.first.throttle << ") " << it.second
                  << std::endl;
    }

    std::cout << std::endl;
    auto distances = GetFreeDistances(grid.GetSparsePointCloud(100501, 0., false), car_info);
    for (auto it : distances) {
        std::cout << "(" << it.first.steering << ", " << it.first.throttle << ") " << it.second
                  << std::endl;
    }

    grid.CleanUpGrid(100501);
    std::cout << grid.DebugGetTiles().size() << std::endl;
    grid.CleanUpGrid(100800);
    std::cout << grid.DebugGetTiles().size() << std::endl;

    std::cout << std::endl;
    for (auto p : grid.GetPoses()) {
        std::cout << p.x << std::endl;
    }
}

void TestRealSample() {
    Pose pose = {0.0, 0.0, -0.005407480988651514};
    PointCloud cloud = {{3.2270003527206557, 0.2814408067334596},
                        {3.2255584661319388, 0.31855045338584376},
                        {3.225677385042097, 0.3558832441552359},
                        {3.2204006388815642, 0.39265528296712954},
                        {3.220651846183762, 0.430147447680859},
                        {3.2194765101873775, 0.4675529978855027},
                        {3.2188543967172376, 0.5051429726373239},
                        {3.2227231566766927, 0.5436114817730644},
                        {3.211370331893261, 0.5795704343616234},
                        {3.216311009517437, 0.6185513541226848},
                        {3.2100010479771353, 0.6555200871152553},
                        {3.2267244211958346, 0.6974961980009012},
                        {3.2302299807278883, 0.7370483456560131},
                        {3.2303340857268044, 0.7760708872491351},
                        {3.228997661050573, 0.8149474416062497},
                        {3.226226594266126, 0.8536389674553283},
                        {3.216410541377957, 0.9303121542122315},
                        {3.213212091366892, 0.9693721877950442},
                        {3.218125834668803, 1.011178384959316},
                        {3.2132339528443903, 1.0501944310493037},
                        {1.0787588985761576, 0.3662920863280126},
                        {1.0584623965903595, 0.3729642472714939},
                        {1.0437924989813934, 0.38127926372874305},
                        {1.0393605774151726, 0.39320001016601347},
                        {1.0310676683569142, 0.4036111629518327},
                        {1.033796730024333, 0.4183860231251297},
                        {1.0372443416547583, 0.43366157361747154},
                        {1.0526418045456334, 0.4543208796015608},
                        {3.224851595577229, 1.570636947304228},
                        {3.2473407986487497, 1.627830919487719},
                        {3.166283726101829, 1.6328054433467318},
                        {3.2251357682016186, 1.710160798977302},
                        {2.4247446900817646, 1.3577387199841848},
                        {2.390409286947567, 1.3746815350141495},
                        {2.4925530919546013, 1.549646329942244},
                        {2.4333403431340552, 1.551724943757734},
                        {2.366879551769366, 1.5477291674523512},
                        {2.36936176484645, 1.588357912957668},
                        {2.0576136600493187, 1.413767432134996},
                        {2.147595259386458, 1.5120635835706742},
                        {2.064457072978903, 1.4891566229728597},
                        {2.1073985981710073, 1.5571066568988297},
                        {2.055948534060592, 1.5557790118539816},
                        {2.007971271697585, 1.555931153462962},
                        {1.9855281714352762, 1.5752357095582679},
                        {1.8633548009943504, 1.513376826664104},
                        {1.7057680522336935, 1.4180932886294768},
                        {1.7099901819407404, 1.4550192714227639},
                        {1.7098172495826252, 1.4889418431535957},
                        {1.7105827008754864, 1.52437965817686},
                        {1.7114976529162105, 1.560701843457928},
                        {1.7118026850780321, 1.5972422677617957},
                        {1.7136631898179988, 1.6360636645741882},
                        {1.7127104558639366, 1.6730378223481506},
                        {1.6963432904958082, 1.734678186504852},
                        {1.6943439261392403, 1.7727743063244819},
                        {1.6971532694357552, 1.8168955564841613},
                        {1.6932723157464151, 1.854847843012691},
                        {1.0539872603238225, 1.1814362287173827},
                        {1.0431899954608532, 1.1966247564180204},
                        {1.6606696185416139, 1.9953426247852544},
                        {1.6265272307557601, 2.0004454194106986},
                        {1.5873559935385348, 1.998569624743248},
                        {1.5490558976924962, 1.9968521849708423},
                        {1.514628066289237, 1.9993048476259723},
                        {1.4749961894593506, 1.9939974215062142},
                        {1.444029286912289, 1.9996004313225821},
                        {1.09135389865146, 1.548266728984086},
                        {1.0627949863172743, 1.5450013953393409},
                        {1.0400280559497557, 1.5495905419564706},
                        {1.0267444846718197, 1.5682940250662027},
                        {1.2597675516538565, 1.9731363589140813},
                        {1.2404061934083705, 1.9927305302578595},
                        {1.2092198693840162, 1.993116566501212},
                        {1.1844221615070454, 2.003596985838201},
                        {0.7900362020180217, 1.3720508397839377},
                        {0.764501014628013, 1.3635573296264314},
                        {0.749803778657669, 1.373973063205847},
                        {0.7316854270981785, 1.3780481251267789},
                        {0.7187339435503803, 1.3918849115656053},
                        {1.00097512758097, 1.9941227568163513},
                        {0.972937064411478, 1.9948869658611936},
                        {0.5772966997548368, 1.3355724036291807},
                        {0.56081517381234, 1.339324607598789},
                        {0.5424452591910075, 1.338241068457574},
                        {0.5252690745571741, 1.3397064713978475},
                        {0.5070675953979716, 1.3381492582372208},
                        {0.4910326643428455, 1.3419865795849049},
                        {0.4749764071344687, 1.345632395311359},
                        {0.4558417549155329, 1.3400927846117867},
                        {0.46910372008183676, 1.4326542178587365},
                        {0.43976473269479305, 1.3969134134317889},
                        {0.4385056170442233, 1.4506732645980502},
                        {0.42256696954463546, 1.5229633703250434},
                        {0.7755467776516367, 3.220432183057759},
                        {0.4043285433791431, 1.7675954838068604},
                        {0.3841257354447139, 1.772351499804404},
                        {0.29234744065281704, 1.4276240869585606},
                        {0.2754216284463794, 1.4279306444248},
                        {0.2633369862668968, 1.4546053667957286},
                        {0.24567124801697002, 1.4516079551546555},
                        {0.22826432131560107, 1.4493853632937648},
                        {0.21137332352809074, 1.4499237653464994},
                        {0.19423407953207206, 1.4482833050053108},
                        {0.17740329427812437, 1.4484262341406662},
                        {0.16048450134516318, 1.4473799253994004},
                        {0.14361294909283667, 1.4461365876918901},
                        {0.12687832519363082, 1.445693027075345},
                        {0.1102487206465447, 1.4460533765549266},
                        {0.09349828248469655, 1.4442266645219182},
                        {0.07696366083863009, 1.4452021250517206},
                        {0.06029371522383084, 1.4429908851387663},
                        {0.043745099537569686, 1.4425868286151913},
                        {0.02723250342194921, 1.4429929946416788},
                        {0.010716340349371646, 1.4432101551323366},
                        {-0.005793187354809665, 1.441238323549043},
                        {-0.02230257061549894, 1.4420775625312845},
                        {-0.03877810576198528, 1.4407281925469826},
                        {-0.05526402614666415, 1.4401900408280306},
                        {-0.07184226291076534, 1.4414607455936659},
                        {-0.10488759781743032, 1.4404362597883815},
                        {-0.12144988535441617, 1.440138044454365},
                        {-0.137184033377203, 1.4309391290290312},
                        {-0.10940876928753891, 1.0183898301820604},
                        {-0.11999287735683851, 1.0081340218665442},
                        {-0.1312635502946455, 1.0047116150098485},
                        {-0.1417672057062264, 0.9962134158241337},
                        {-0.15422456769857149, 1.0014441230991582},
                        {-0.16616605731439799, 1.0025731559201723},
                        {-0.17762915559470344, 1.0006058038297891},
                        {-0.18944107441642247, 1.0004724476556357},
                        {-0.20206228473472335, 1.0041209877813746},
                        {-0.21354074635368472, 1.0017427187965835},
                        {-0.22543056114791513, 1.0011843658325967},
                        {-0.24973780333121823, 1.0015843392153607},
                        {-0.2616901535186068, 1.0005955074105948},
                        {-0.273652515047119, 0.9994640331827536},
                        {-0.28617337971583773, 1.0001123647765648},
                        {-0.2978865549155967, 0.9977299950589085},
                        {-0.30987965733872164, 0.9961651905399543},
                        {-0.32341562567236987, 0.9992134445401316},
                        {-0.33674280920482647, 1.0011335038759404},
                        {-0.3485079117669035, 0.998158227102766},
                        {-0.3605893718059193, 0.9959848700555323},
                        {-0.37372012669482263, 0.9964744418017151},
                        {-0.3865472201948761, 0.9958610258128673},
                        {-0.3997815920924691, 0.9960122287670996},
                        {-0.4138359414490887, 0.9978376268891118},
                        {-0.42640954920904667, 0.9957939335112658},
                        {-0.4389903807792689, 0.9935926701275102},
                        {-0.45323490079897216, 0.9948737439673866},
                        {-0.4684157278335981, 0.9977683720524746},
                        {-0.47501578047037063, 0.9824390291109552},
                        {-0.4764257064628573, 0.9572429588190997},
                        {-0.47413187438482046, 0.9259151749103665},
                        {-0.474446757355, 0.9009624374131436},
                        {-0.47568203955439725, 0.8787645584926711},
                        {-0.47841685548267043, 0.860154284256318},
                        {-0.48128499610551945, 0.8424665188482955},
                        {-0.4812821210131108, 0.8205145423723554},
                        {-0.4803252746829792, 0.7978183681736469},
                        {-0.47523447632346205, 0.7692985776543497},
                        {-0.47223191766475786, 0.7452262057861265},
                        {-0.4681972707106378, 0.720487261350649},
                        {-0.46754100956856043, 0.7017662912013546},
                        {-0.4682105933954475, 0.6856339722514229},
                        {-0.4708665072075447, 0.6728568422290094},
                        {-0.47445733726561456, 0.6617350566430299},
                        {-0.47726386159289885, 0.649813996827122},
                        {-0.4804614579613267, 0.6387153987378221},
                        {-0.48102708945086997, 0.6244606052988341},
                        {-0.4788531175300983, 0.6071369114616006},
                        {-0.47194937009019466, 0.5845001262261105},
                        {-0.464591981065961, 0.5621030811139082},
                        {-0.4483893892935459, 0.5300283019374181},
                        {-0.43740750080480256, 0.5052056741977798},
                        {-0.43453953155438324, 0.4904365146363645},
                        {-0.4347503708446486, 0.4795046123131462},
                        {-0.4361288786490095, 0.4700991193936311},
                        {-0.43734954128746906, 0.4607254129066334},
                        {-0.4391100706985482, 0.45210328406301264},
                        {-0.44002611011104575, 0.4427923648527589},
                        {-0.4422130008564941, 0.43492264577857137},
                        {-0.44427776996171425, 0.42706123585648187},
                        {-0.4469497537245739, 0.4198946310680942},
                        {-0.4502527356319773, 0.4133993422264374},
                        {-0.45272153385223984, 0.406215831756723},
                        {-0.45658890360549176, 0.4003487298470694},
                        {-0.45962204055593486, 0.3937958144643253},
                        {-0.46333196972391094, 0.3878679737271879},
                        {-0.46696651863075317, 0.3819068802665133},
                        {-0.47130668215548344, 0.3765376555838959},
                        {-0.4755851131753908, 0.3711191113954887},
                        {-0.4798012512947213, 0.3656519574308965},
                        {-0.4839545442769447, 0.36013690978671054},
                        {-0.48885346285912723, 0.3551624572813315},
                        {-0.49370180405495323, 0.3501229674375951},
                        {-0.49767646465494686, 0.34444985147765156},
                        {-0.5024146533419059, 0.33929126742845345},
                        {-0.5062647795923623, 0.33351914636220015},
                        {-0.5117312575250597, 0.3287844419298944},
                        {-0.5163079654447142, 0.32343725567385595},
                        {-0.5216826552489245, 0.3185494456277739},
                        {-0.5297019808335457, 0.3070274219023745},
                        {-0.5349228152997897, 0.30192821902547834},
                        {-0.5394387123151405, 0.29638841540204874},
                        {-0.4385134438102697, 0.23444298422105475},
                        {-0.44028061155402143, 0.22894769957148184},
                        {-0.44019467270749557, 0.22254038925628153},
                        {-0.4391225384417827, 0.21572427524901217},
                        {-0.4397575803480381, 0.20982333821283491},
                        {-0.439407921522902, 0.203515969342561},
                        {-0.43897182245258454, 0.19724423976066482},
                        {-0.4375333411062398, 0.19060993481663738},
                        {-0.43600095682778306, 0.18403458839277997},
                        {-0.432524494535642, 0.17676287597624213},
                        {-0.4289394528553372, 0.16959514993772135},
                        {-0.4252477043834638, 0.16253291315272655},
                        {-0.42426561043069605, 0.15661659476652703},
                        {-0.4232041657420957, 0.15074418049181504},
                        {-0.4230100381530773, 0.1452414465615351},
                        {-0.4236950824214467, 0.1400768795493501},
                        {-0.4243174738819557, 0.13491570661846244},
                        {-0.42583373212067993, 0.13005075594588508},
                        {-0.4272942139744787, 0.12516877101679788},
                        {-0.42966154275565327, 0.12054050659106934},
                        {-0.43101293356939535, 0.11561533699429208},
                        {-0.43230786961810286, 0.11067502391532193},
                        {-0.4335461812889762, 0.10572021444428628},
                        {-0.43472770638596747, 0.10075155757007316},
                        {-0.4358522901510252, 0.0957697040953256},
                        {-0.43691978528436504, 0.09077530655119864},
                        {-0.43793005196376283, 0.08576901911188954},
                        {-0.43888295786286946, 0.08075149750895314},
                        {-0.4397783781685424, 0.07572339894541302},
                        {-0.44061619559719467, 0.07068538200968005},
                        {-0.4404071897639675, 0.06549102028620346},
                        {-0.440137102496734, 0.060310716214984995},
                        {-0.4407985054905546, 0.05526960323612295},
                        {-0.4404085951713676, 0.05010820513547244},
                        {-0.4409532174197411, 0.04506465322061951},
                        {-0.44186912786801763, 0.03496050285498845},
                        {-0.44224029610050175, 0.02990122786202408},
                        {-0.4415551231054893, 0.02478200090076352},
                        {-0.44180982371042693, 0.019726986143623906},
                        {-0.4410071887103883, 0.014636217055444054},
                        {-0.44014606043628185, 0.009566408395830466},
                        {-0.4392267539634979, 0.004518229771251545},
                        {-0.43824971131103574, -0.0005075758261866355},
                        {-0.43721526350832646, -0.005510502607702009},
                        {-0.43512416881473714, -0.010465775572949879},
                        {-0.43297715181717555, -0.01537391235352797},
                        {-0.4317739330080698, -0.020281205523091445},
                        {-0.4295169503352856, -0.025104629799168506},
                        {-0.427206409684012, -0.02987906768354851},
                        {-0.4224278141746071, -0.03927861983334246},
                        {-0.4209560266558784, -0.04400656137189556},
                        {-0.4194315111297188, -0.04870597690458503},
                        {-0.41884662510948845, -0.05350298448854086},
                        {-0.41820687788681055, -0.058292984165812925},
                        {-0.417512353256802, -0.06307534853456423},
                        {-0.41775013514131476, -0.0680101346204835},
                        {-0.4189146402747535, -0.07313057767667275},
                        {-0.4200164027801431, -0.07828653819189146},
                        {-0.42203565813290694, -0.08367171760518376},
                        {-0.4239863099140673, -0.08911329969325504},
                        {-0.4258672742423423, -0.09461040254379377},
                        {-0.42865123645011594, -0.10039017968387984},
                        {-0.4313581466849965, -0.10624594473705794},
                        {-0.4317092173877292, -0.11687481251334475},
                        {-0.43322995441095724, -0.12262491136137042},
                        {-0.43563427992388887, -0.1287083672614299},
                        {-0.43699987411294283, -0.1345684645566596},
                        {-0.4382880206941593, -0.14047656181000415},
                        {-0.4394978294834814, -0.146431659013224},
                        {-0.4406283383740553, -0.15243271349999737},
                        {-0.4407374517640947, -0.15814097236651026},
                        {-0.4417106811176622, -0.16422007928227234},
                        {-0.4416688700528977, -0.1699828618003558},
                        {-0.4424818495797976, -0.17613593750177897},
                        {-0.4413618956361417, -0.18156885446260762},
                        {-0.4410957989664395, -0.18739015952969},
                        {-0.44075399995771286, -0.1932290416769241},
                        {-0.44124732985977594, -0.19949652920824743},
                        {-0.4407481372270225, -0.20537807766001626},
                        {-0.4401718524196595, -0.21127420689287013},
                        {-0.44041466474587276, -0.21762696012994218},
                        {-0.44056934406058035, -0.2240127565623808},
                        {-0.4424074864126737, -0.23135724157388945},
                        {-0.4450154178313244, -0.2392463526658301},
                        {-0.44662473544402725, -0.24674152460832136},
                        {-0.44725050817561335, -0.25381100316800354},
                        {-0.44863650871564414, -0.26143033544803773},
                        {-0.44679677358748576, -0.2742456473930343},
                        {-0.44701377168279244, -0.2814724289511721},
                        {-0.4479634863350737, -0.28928230147901923},
                        {-0.44795865217927777, -0.2965983639205529},
                        {-0.44784459832636137, -0.3039519171289691},
                        {-0.44597859972448967, -0.3101994157151916},
                        {-0.4432136512995606, -0.3158634740811377},
                        {-0.43956971522555494, -0.3209151607721557},
                        {-0.4350673536600868, -0.3253259699155167},
                        {-0.43052166592055097, -0.3296758003977374},
                        {-0.4251466172674269, -0.33334729627315396},
                        {-0.4213037702542992, -0.33819106918437475},
                        {-0.41663313424939774, -0.34235567971141556},
                        {-0.4126877480580008, -0.3471014298270148},
                        {-0.40868830736374645, -0.35180171604086574},
                        {-0.40613605039840783, -0.35777794893377307},
                        {-0.4027575940768613, -0.3630721121324433},
                        {-0.40078116548964, -0.36969178828964144},
                        {-0.39943290767357276, -0.37699989668528266},
                        {-0.3986888090567598, -0.38501986721102915},
                        {-0.4013696497845612, -0.3965860034368927},
                        {-0.3998333074447508, -0.4135769853014836},
                        {-0.40812286530788205, -0.43193612616012117},
                        {-0.42486236685038564, -0.4600881084842355},
                        {-0.43832822144261213, -0.4857071818285105},
                        {-0.4492765665421387, -0.5094419808449636},
                        {-0.4538616571595716, -0.5266707923543307},
                        {-0.4548894604480279, -0.5402449982291501},
                        {-0.4543944716806073, -0.5523660456923468},
                        {-0.45681294736533185, -0.5684430611661485},
                        {-0.45037550196396575, -0.5874793247625593},
                        {-0.44901617021088897, -0.5997999946058692},
                        {-0.4474331142999523, -0.6121655559040802},
                        {-0.4444635379390011, -0.6229444337509609},
                        {-0.44130528206853303, -0.6337347279130974},
                        {-0.4379577725617248, -0.6445336237023725},
                        {-0.434420341070745, -0.6553380976760876},
                        {-0.4312354351917527, -0.6669850673845101},
                        {-0.4278402732195556, -0.6786440948585345},
                        {-0.424757718421087, -0.6911637987638068},
                        {-0.42966486107990226, -0.7174274748125002},
                        {-0.43049715860441584, -0.7378450261126227},
                        {-0.4325228047003625, -0.761199260592313},
                        {-0.4840730815080128, -0.8992356942082175},
                        {-0.48395565792786177, -0.9242063676665929},
                        {-0.47833782744344033, -0.9394870884468471},
                        {-0.4715459398526417, -0.9529663548694419},
                        {-0.4628831897358643, -0.9630324461470872},
                        {-0.27200799622657196, -0.5829083956900787},
                        {-0.2636691990557525, -0.5823393263160318},
                        {-0.2541732455472508, -0.5789093518125878},
                        {-0.24713974944050915, -0.5808601697885891},
                        {-0.24247587993917644, -0.5885046294310262},
                        {-0.3885555368689202, -1.0079507482209897},
                        {-0.38013544001015587, -1.0207656641894665},
                        {-0.38136608506071223, -1.0610449039496885},
                        {-0.4288526557977114, -1.2848174187247263},
                        {-0.463879056029091, -1.4445980781338992},
                        {-0.45151712681454936, -1.4634290138890065},
                        {-0.4133784440304973, -1.396346012144592},
                        {-0.39525610463453303, -1.3935296801640507},
                        {-0.39702189006352834, -1.4633481214976307},
                        {-0.37924540839957444, -1.463923775741796},
                        {-0.36150791307894625, -1.4642848375667175},
                        {-0.3438119531393804, -1.4644321604544213},
                        {-0.32616006583353235, -1.4643666274492089},
                        {-0.30834862163405585, -1.4631109493503545},
                        {-0.2909987831883915, -1.4636016084365995},
                        {-0.2736781786396585, -1.4638871719795836},
                        {-0.2563892460719541, -1.4639684916570157},
                        {-0.23913434754392726, -1.4638460955283048},
                        {-0.22191589617550173, -1.4635208916677536},
                        {-0.2047362695291662, -1.462993698984734},
                        {-0.187470590735431, -1.461273565366648},
                        {-0.17085060241181763, -1.4643165686570119},
                        {-0.1537674611012095, -1.4631925022968413},
                        {-0.13703511708711022, -1.4651053688244158},
                        {-0.09124623461767732, -1.1127652130565306},
                        {-0.08595842386788402, -1.2194741972487448},
                        {-0.07924030244989859, -1.343164622798318},
                        {-0.053943182958087206, -1.135219091268312},
                        {-0.077681610904969, -1.075551174355348},
                        {-0.0263421462889053, -1.0709260348404117},
                        {-0.014133477733187023, -1.0749071342805185},
                        {-0.0018260595948845213, -1.0722484536770138},
                        {0.010406474701914087, -1.0681992517586412},
                        {0.022673205662887636, -1.0700098418861412},
                        {0.03495010589275198, -1.0706796770594826},
                        {0.047421553867815505, -1.0752047090454382},
                        {0.05993176411724057, -1.0783358828987102},
                        {0.07360720014932925, -1.0975345245313537},
                        {0.0989770162843211, -1.0985502487944352},
                        {0.11103729394298541, -1.0923711952700872},
                        {0.12330667648354475, -1.0890414901984662},
                        {0.13625766206731812, -1.0915282414944822},
                        {0.14576594303941595, -1.0680993309965958},
                        {0.16193713895489573, -1.093069716522925},
                        {0.17479138489126797, -1.0933665805017487},
                        {0.18949197813172278, -1.1041072514977086},
                        {0.2019351520174812, -1.1008827772461869},
                        {0.21375434255543269, -1.0945737181177702},
                        {0.22403548771108278, -1.081284449924696},
                        {0.23618154753077544, -1.0776729086443044},
                        {0.2494005030801902, -1.078796503819716},
                        {0.2596030943471324, -1.067126686496032},
                        {0.2755111085911937, -1.0786191310018831},
                        {0.2873848855300371, -1.0737049095023066},
                        {0.4279812791845826, -1.4639738587705233},
                        {0.4455824437735284, -1.461849610655244},
                        {0.4640984118690706, -1.4623733418591502},
                        {0.48237109781054544, -1.4617143142239246},
                        {0.5010135256189621, -1.4617739871245554},
                        {0.5200552551066668, -1.4625398045850637},
                        {0.5425513276346821, -1.4722089100523825},
                        {0.5583841205426747, -1.4633339099013993},
                        {0.5776650117374551, -1.4633587635153145},
                        {0.5973970012614878, -1.464058822105189},
                        {0.616831984445243, -1.4635766108158612},
                        {0.6363337746374083, -1.4628403614972432},
                        {0.6571272331820683, -1.4645857315200947},
                        {0.6772039119144019, -1.464230336925982},
                        {0.6969279315593576, -1.4627034824075085},
                        {0.7193479658545742, -1.4663028542189134},
                        {0.7392367895832089, -1.4642229765499308},
                        {0.7611305449851342, -1.4656508790946174},
                        {0.5288083367648813, -0.913478000496218},
                        {0.8358205732650507, -1.3704858754721456},
                        {0.8523864886954262, -1.3282735019317191},
                        {0.8532404471511646, -1.2967115668895135},
                        {0.852367107231825, -1.263648871341279},
                        {0.8525567812432956, -1.2332467961656512},
                        {0.8521640177933284, -1.2030084905628298},
                        {0.8523674113497983, -1.174562145655588},
                        {0.8520330818895899, -1.1462711554556833},
                        {0.8523761031253124, -1.1197355370097934},
                        {0.8529934224152721, -1.094330207770303},
                        {1.1807703531034106, -1.479604811598801},
                        {1.1977845618851857, -1.4661881402045442},
                        {1.2266741491204167, -1.4669596977634083},
                        {1.2563868603837838, -1.4680198254813743},
                        {1.284965078416592, -1.4670855207055413},
                        {1.3150197801185994, -1.4671769088062696},
                        {1.3416945849461415, -1.4629014654164192},
                        {1.4477995978363254, -1.3141076759413226},
                        {1.4717214337830327, -1.3054150843961727},
                        {1.4769302737621162, -1.2801355630840903},
                        {1.5393688694065315, -1.3037029157934712},
                        {1.5511065683385177, -1.2834502052177708},
                        {1.5726925858826073, -1.271272133824588},
                        {1.595772045016945, -1.2600069535117149},
                        {1.6505534351393654, -1.24300554099528},
                        {1.6541975181743098, -1.2163331940034026},
                        {1.6509495480777627, -1.1850760978139474},
                        {1.652938176859036, -1.1580709821888506},
                        {1.6512244362177162, -1.1289190972545156},
                        {1.6515574483568356, -1.1016240475456236},
                        {1.6539983650721346, -1.0761064515372092},
                        {1.6552284129772088, -1.0501423912448415},
                        {1.6943534672904765, -1.0479629065877236},
                        {1.741349961165744, -1.0496695933976077},
                        {1.789464870120388, -1.0509413252089088},
                        {1.8532376694334984, -1.0320907610069991},
                        {1.906248986486821, -1.0332101567210503},
                        {1.9595230423291778, -1.0332483131779449},
                        {2.0192710677756884, -1.0353934211003857},
                        {2.081108652600224, -1.0371952186915545},
                        {2.1452706903689998, -1.0386945594566932},
                        {2.2131260839209568, -1.0404531142301534},
                        {2.2831152506818797, -1.0416213976899558},
                        {3.5703569185004866, -1.5797844179610898},
                        {3.5643076513028533, -1.5285722511247615},
                        {3.558480620797527, -1.47809047074061},
                        {3.5751636268338602, -1.4372685238499832},
                        {3.5969706238382018, -1.3984324880852692},
                        {3.6108671238297796, -1.3564718888573117},
                        {3.639316007405769, -1.3198313893054807},
                        {3.6704657770318057, -1.2368292530658416},
                        {3.6938926924137623, -1.197826082792816},
                        {3.7130876072626613, -1.157258093449765},
                        {3.730878833387009, -1.1161207548683365},
                        {3.7501368038597773, -1.0752788577439454},
                        {3.775698435498558, -1.0359943916571321},
                        {3.7960133615287437, -0.9949973559640956},
                        {3.8139433615612153, -0.9531858932703413},
                        {3.8382224956678197, -0.9127134857929466},
                        {3.8571958690149364, -0.8707088261018823},
                        {3.8805988197584105, -0.8294342350092685},
                        {3.9204696609386938, -0.7911499083865207},
                        {4.166035130357706, -0.7911961300198063},
                        {4.072427970570226, -0.7252321670944946},
                        {3.984282225424917, -0.6625831461025815},
                        {3.981721364805769, -0.6154140113524904},
                        {4.033051497844132, -0.5761689441391923},
                        {4.0458263627964675, -0.530820421092374},
                        {4.240043897985809, -0.5070122975796857},
                        {4.238609221419801, -0.4577022582820731},
                        {4.187828570418457, -0.40378883385848297},
                        {4.142354441093691, -0.35160580800473884},
                        {4.121174032103828, -0.30234627903154326},
                        {4.072463529638874, -0.25195062808108853},
                        {4.049184568059878, -0.15758697375296116},
                        {4.081961116905067, -0.11209345370702657},
                        {3.230216235307468, -0.014743529620059207},
                        {3.2221737110163584, 0.02217070589319001},
                        {3.228707749079721, 0.05917379391165259},
                        {3.221821698680581, 0.09594237232695739},
                        {3.2165161317491484, 0.13264351988950535},
                        {3.2217777026313064, 0.16981480081812214},
                        {3.217627507530805, 0.206547305869986},
                        {3.2260214861173306, 0.24418826533298235},
                        {-0.433, 0.08}};
    CarInfo car_info = {0.203, 0.05, 0.715, 0.31427220977944387, 0.4170202921176725};
    double ts_double = 1634397523.430856;
    int ts = static_cast<int>(ts_double);
    Grid grid;

    grid.UpdateGrid(cloud, pose, ts);

    std::cout << "read data, GetFreeDistances" << std::endl;
    auto distances = DebugGetFreeDistances(grid, ts, car_info);
    for (auto it : distances) {
        std::cout << "(" << it.first.steering << ", " << it.first.throttle << ") " << it.second
                  << std::endl;
    }

    std::cout << std::endl;
    auto weights = grid.GetDirectionsWeights(ts, car_info);
    for (auto it : weights) {
        std::cout << "(" << it.first.steering << ", " << it.first.throttle << ") " << it.second
                  << std::endl;
    }

    std::cout << std::endl;
    auto points = grid.DebugGetFreeTileCenters(false);
    for (auto it : points) {
        std::cout << "(" << it.x << ", " << it.y << ")" << std::endl;
    }

    std::cout << std::endl;
    points = grid.DebugGetFreeTileCenters(true);
    for (auto it : points) {
        std::cout << "(" << it.x << ", " << it.y << ")" << std::endl;
    }
}

void TestTransformations() {
    PointCloud cloud = {{3.4034514476480053, 0.29831379298071475}};
    CloudTransformation transformation = {-0.006499836686998606, -1.0936673879623413,
                                          -1.0233333110809326};
    auto result_cloud = ApplyTransformation(cloud, transformation);
    for (auto it : result_cloud) {
        std::cout << "(" << it.x << ", " << it.y << ")" << std::endl;
    }

    auto reverted_cloud = RevertTransformation(result_cloud, transformation);
    for (auto it : reverted_cloud) {
        std::cout << "(" << it.x << ", " << it.y << ")" << std::endl;
    }
}

int main() {
    TestBasics();
    TestTransformations();
    TestRealSample();
}
